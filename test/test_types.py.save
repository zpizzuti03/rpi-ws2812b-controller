"""
test_types

This module verifies that default values apply
correctly to types and that their functions return expected results
"""
import pytest
from led.types import PixelRange, ColorPalette
from led.colors import COLORS, OFF
from led.config import LED_COUNT

MIN_RANGE = 0
MAX_RANGE = LED_COUNT
RANGE_TOO_LOW = -1
RANGE_TOO_HIGH = MAX_RANGE + 1

# ----- Color Palette -----

@pytest.mark.parametrize("function", [
	"get_span_primary",
	"get_span_secondary",
	"get_space_primary",
	"get_space_secondary"
])
def test_default_color_palette(function):
	"""
	Tests that a default ColorPalette object returns the expected values
	"""
	p = ColorPalette()

	assert getattr(p, function)() == OFF

@pytest.mark.parametrize("field, value", [
	("span_primary", "invalid"),
	("span_secondary", "invalid"),
	("spacing_primary", "invalid"),
	("spacing_secondary", "invalid")
])
def test_color_palette_invalid_colors(field, value):
	"""
	Tests that a palette with invalid colors will throw errors
	"""
	with pytest.raises(ValueError):
		ColorPalette(**{field: value})

# ----- Pixel Range -----

@pytest.mark.parametrize("function, expected", [
	("get_start", MIN_RANGE),
	("get_end", MAX_RANGE),
	("get_span", 1),
	("get_spacing", 0),
	("is_inverted", False),
	("is_default", True)
])
def test_default_pixel_range(function, expected):
	"""
	Tests that a default PixelRange returns expected values
	"""
	r = PixelRange()

	assert getattr(r, function)() == expected

@pytest.mark.parametrize("field, original, expected", [
	("start", RANGE_TOO_LOW, MIN_RANGE),
	("start", RANGE_TOO_HIGH, MAX_RANGE),
	("end", RANGE_TOO_LOW, MIN_RANGE + 1),
	("end", RANGE_TOO_HIGH, MAX_RANGE),
])
def test_pixel_range_invalid_ranges(field, original, expected):
	"""
	Tests that invalid PixelRange args are processed properly
	"""
	r = PixelRange(**{field: original})

	actual = getattr(r, f"get_{field}")()

	assert actual == expected
	assert actual != original

@pytest.mark.parametrize("start, end", [
	(MIN_RANGE, MAX_RANGE),
	(MIN_RANGE, 50),
	(30, MAX_RANGE),
	(10, 40),
	(5, 55),
	(25, 35),
])
def test_pixel_range_inversion(start, end):
	"""
	Tests that inversion returns a valid inverted range
	"""
	r = PixelRange(start=start, end=end, invert=True)

	original = range(start, end)
	expected = range(end - 1, start - 1, -1)

	assert r.get_length() == expected
	assert r.get_length() != original

@pytest.mark.parametrize("index, expected", [
	(0, True),
	(2, True),
	(3, False),
	(4, False),
	(5, True),
	(7, True),
	(8, False)
])
def test_pixel_range_is_in_span(index, expected):
	"""
	Test values in a range and verify if they are in the span.

	Tests arbitrary values along a range with predetermined span and spacing 
	to determine whether they are located in the span or spacing
	"""
	r = PixelRange(span=3, spacing=2)

	assert r.is_in_span(index) == expected

@pytest.mark.parametrize("", [
	(),
])
def test_pixel_range_invalid_span():
	


@pytest.mark.parametrize("start, end, original", [
	(MIN_RANGE, MAX_RANGE, 1),
	(20, 40, 1),
	(48, 59, 1),
])
def test_pixel_range_invalid_spacing(start, end, original):
	"""
	Tests invalid spacing arguments and ensures they are properly clamped in relation to span
	"""
	r = PixelRange(start=start, end=end, span=MAX_RANGE, spacing=original)


	assert r.get_spacing != original
